-- time ../mad -Oloopunroll=500 -Oinstunroll=100 -jp=vl ex-lhc-rdt-ip.mad
local beam, track, twiss, option in MAD
local assertf in MAD.utility

-- load LHC B1
MADX:load("lhcb1.seq", "lhcb1.mad") -- convert on need

local lhcb1 in MADX

-- attach beam
lhcb1.beam = beam { particle="proton", energy= 450 } -- mass=0.938272046 }

-- sanity checks
assertf(#lhcb1 == 6732, "invalid number of elements %d in LHCB1 (6732 expected)", #lhcb1)

-- octupoles setup
MADX:open_env()
ko = kmax_MO/Imax_MO * 40 / (450*3.33)
kof_a81b1 =\ ko
kof_a12b1 =\ ko
kof_a23b1 =\ ko
kof_a34b1 =\ ko
kof_a45b1 =\ ko
kof_a56b1 =\ ko
kof_a67b1 =\ ko
kof_a78b1 =\ ko

kod_a81b1 =\ ko
kod_a12b1 =\ ko
kod_a23b1 =\ ko
kod_a34b1 =\ ko
kod_a45b1 =\ ko
kod_a56b1 =\ ko
kod_a67b1 =\ ko
kod_a78b1 =\ ko

dQx_b1_op  = -0.035
dQy_b1_op  = -0.025
dQpx_b1_op = 15
dQpy_b1_op = 15
MADX:close_env()

local mtbl = twiss {sequence=lhcb1, method=4, chrom=true}

local cols = {"name","s","betx","bety","mux","muy","dx","dy","x","y"}
mtbl:write("twiss_b1_ng.tfs", cols)

--[[
twiss, file=twiss_b1;


PTC_CREATE_UNIVERSE;
PTC_CREATE_LAYOUT, MODEL=2, METHOD=6, NST=3;
ptc_twiss, NORMAL=TRUE, TRACKRDTS=TRUE, NO=4 ;
write, table=TWISSRDT , file=rdts;

stop;

--]]
