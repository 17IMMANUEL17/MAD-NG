local assertEquals, assertAllAlmostEquals in MAD.utest

-- TODO: THIS IS A CRAPPY AD HOC SOLUTION FOR THE LACK OF KNOWLEDGE ABOUT
-- FILTER+MAP IN LUAFUN/MAD. IT WILL BE THROWN AWAY ASAP!
local function parse_table(lines)
  local tab = {}
  local result = {}
  local columns = {}
  for line in lines do
    if line:match('^%s*#') then
      -- comment specifies the column titles
      line = line:gsub('^%s*#%s*', '')
      for col in string.gmatch(line, "%S+") do
        tab[col] = {}
        table.insert(columns, col)
      end
    else
      local row = {}
      for num in string.gmatch(line, "%S+") do
        table.insert(row, tonumber(num))
      end
      for i, num in ipairs(row) do
        table.insert(tab[columns[i]], num)
      end
      table.insert(result, row)
    end
  end
  return tab, result, columns
end

Test${suite} = {
  setUp = function (self)
    self.expected = parse_table(io.lines("${expected}"))
    self.actual = parse_table(io.lines("${actual}"))

    -- same parameters -> data loaded correctly
    assertEquals(self.actual.i, self.expected.i)
    assertAllAlmostEquals(self.actual.${varname}, self.expected.${varname})
  end,

  testOrbit = function (self)
    expected = self.expected
    actual = self.actual

    -- same output
    assertAllAlmostEquals(actual.s,  expected.s,  ${margin})
    assertAllAlmostEquals(actual.x,  expected.x,  ${margin})
    assertAllAlmostEquals(actual.px, expected.px, ${margin})
    assertAllAlmostEquals(actual.y,  expected.y,  ${margin})
    assertAllAlmostEquals(actual.py, expected.py, ${margin})
    assertAllAlmostEquals(actual.t,  expected.t,  ${margin})
    assertAllAlmostEquals(actual.pt, expected.pt, ${margin})
  end,
}
