-- ../mad test-electric-maps.mad
-- assume ../madx64 to be present...

local object, tostring                                          in MAD
local tblcat                                                    in MAD.utility
local run_test in require("trackvsptc")

-- The setup for the tests ----------------------------------------------------o

local ref_cfg = object "ref" {
  -- How to run the tests
  dorun  = true, -- Default: true 
  dosave = true, -- Default: false
  doprnt = false, -- Default: false
  dodbg  = false, -- Default: false
  doplot = true, -- Default: false
  
  -- list of variables in the tests
  alist = {"model", "energy", "method", "nslice", "x0i"}, --attributes list
  tol = 1000,

  -- list of values that are used to run test but are not changed throughout
  order  = 4,        -- 2/4
  icase  = 6,       -- 56/6
  debug  = 0,        -- 0/6
  snm    = -1,

  x0i    = 1..4,       -- 0, 4D, 5D, 6D (see get_mad_str)
}

local function testCAV() -- ~15 mins
  local cfg = ref_cfg "cavity" {
    elm =  [[
      RFCAVITY, at=0.75, l=1.5, 
      volt=${volt}, lag=${lag}, harmon=${harmon}, freq=${freq}, 
      no_cavity_totalpath=${no_totalpath};
    ]],

    model  = 1..2,
    method = 2..8..2,    
    nslice = 1..3,
    energy = {1, 6500},  -- {1, 450, 6500}

    tol = 50,

    alist = tblcat(
      ref_cfg.alist, 
      {"no_totalpath", "volt", "lag", "freq", "harmon"}
    ),
    no_totalpath = {true, false},
    volt      = -8 ..8  ..8   ,
    lag       =  0 ..0.9..0.45,
    freq      =  0 ..150 ..75,
    harmon    = \s-> s.cur_cfg.freq == 0 and {2} or {0},

    plot_info = {
      x_axis_attr = "${volt}",
      legend = {
        y1 = "Total path on",
        y2 = "Total path off",
      },
      series = {
        "${no_totalpath} == true",
        "not ${no_totalpath} == true",
      },
      title = "Cavity body NG vs PTC",
      filename = "cavity-body.png",
      xrange = {-8.1, 8.1},
    }
  }
  run_test(cfg)
end

local function testCCAV() -- ~10 mins
  local cfg = ref_cfg "crabcavity" {
    elm =  [[
      CRABCAVITY, at=0.75, l=1.5,
      volt=${volt}, lag=${lag}, harmon=${harmon}, freq=${freq}, 
      no_cavity_totalpath=${no_totalpath};
    ]],

    model  = 1..2,
    method = 2..8..2,    
    nslice = 1..3,
    energy = {1, 6500},  -- {1, 450, 6500}

    tol = 1000,

    alist = tblcat(ref_cfg.alist, {"volt", "lag", "freq", "harmon", "no_totalpath"}),
    no_totalpath = {true, false},
    volt      = -8 ..8  ..8   ,
    lag       =  0 ..0.9..0.45,
    freq      =  75 ..150 ..75,
    harmon    = \s-> s.cur_cfg.freq == 0 and {2} or {0},

    plot_info = {
      x_axis_attr = "${volt}",
      legend = {
        y1 = "Total path on",
        y2 = "Total path off",
      },
      series = {
        "${no_totalpath} == true",
        "not ${no_totalpath} == true",
      },
      title = "Crab cavity body NG vs PTC",
      filename = "crabcavity-body.png",
      xrange = {-8.1, 8.1},
    }
  }
  run_test(cfg)
end

local function testRFMULT() -- ~40 mins
  local cfg = ref_cfg "rfmultipole" {
    elm =  [[
      RFMULTIPOLE, at=0.75, lrad=1.5, 
      volt=${volt}, lag=${lag}, harmon=${harmon}, freq=${freq}, 
      pnl=${pnl}, psl=${psl}, knl=${knl}, ksl=${ksl},
      no_cavity_totalpath=${no_totalpath};
      ;
      ]],

      model  = {1},
      method = {2, 6},    
      nslice = 1..2,
      energy = {1, 6500},  -- {1, 450, 6500}
  
      tol = 12000,

      alist = tblcat(
      ref_cfg.alist, 
      {"lag", "freq", "harmon", "no_totalpath", "knl", "ksl", "pnl", "psl", "volt"}
    ),
    no_totalpath = {true, false},
    volt      = {-8, 8}       ,
    lag       =  0 ..0.9..0.45,
    freq      =  0 ..150 ..75 ,
    knl       = {
      {0   ,  0, 0 ,  0   }, 
      {0.5, 5, -50,  500, -1500 },
    },
    ksl       = {
      {0   ,  0, 0 ,  0   }, 
      {0.5, 5, -50, -500,  1500 },
    },    
    pnl       =  {
      {}, 
      {0.2, -0.2, 0.2, -0.2},
    },
    psl       = \s-> s.pnl,
    harmon    = \s-> s.cur_cfg.freq == 0 and {2} or {0},

    plot_info =  \s -> {
      series = {
        "${volt} == " .. s.volt[1],
        "${volt} == " .. s.volt[2],
      },
      legend = {
        y1 = "Voltage =" .. s.volt[1],
        y2 = "Voltage =" .. s.volt[2],
      },
      title  = "Multipole NG vs PTC tilt, no lrad, order " .. ref_cfg.order,
      filename = "rfmult-body.png",
    }
  }
  run_test(cfg)
end 

testCAV()
testCCAV()
testRFMULT()
