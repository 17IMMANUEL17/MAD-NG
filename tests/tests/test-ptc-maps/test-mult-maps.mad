-- ../mad test-mult-maps.mad
-- assume ../madx64 to be present...

local object, tostring                                          in MAD
local tblcat                                                    in MAD.utility
local run_test in require("trackvsptc")

-- The setup for the tests ----------------------------------------------------o

local ref_cfg = object "ref" {
  -- How to run the tests
  dorun  = true, -- Default: true 
  dosave = true, -- Default: false
  doprnt = false, -- Default: false
  dodbg  = false, -- Default: false
  doplot = true, -- Default: false
  
  -- list of variables in the tests
  alist = {"model", "energy", "method", "nslice", "x0i"}, --attributes list
  tol = 1000,

  -- list of values that are used to run test but are not changed throughout
  order  = 6,        -- 2/4
  icase  = 56,       -- 56/6
  debug  = 0,        -- 0/6
  snm    = -1,

  x0i    = 1..4,       -- 0, 4D, 5D, 6D (see get_mad_str)
}

local function testMULT() -- Test multipole (1 min)
  local cfg = ref_cfg "mult" {
    elm =  [[
      MULTIPOLE, at=0.75,
      knl=${knl}, ksl=${ksl}, tilt=${tilt}*pi/8
    ]],
    
    tol = 33000, -- Large error at order 6, big knl ksl
    
    energy = {1, 6500},
    model  = {1},
    method = {2},
    nslice = {1},

    knl = {
      {0   ,  0, 0 ,  0   }, 
      { 0.5,  0, 0 ,  0   },
      { 0  , -5, 0 ,  0   },
      { 0  ,  0, 50,  0   },
      { 0  ,  0, 0 , -500},
      { 0  ,  0, 0 , 0  , 1500 }, 
      {0.5, 5, -50, 500, -1500 },
    },
    tilt  = 0..4,
    ksl   = {{}},!\s->s.knl,

    alist = tblcat(ref_cfg.alist, {"knl", "ksl", "tilt"}),
    plot_info =  \s -> {
      x_axis_attr = "${tilt}",
      series = {
        "'${knl}' == '" .. tostring(s.knl[1]) .. "'",
        "'${knl}' == '" .. tostring(s.knl[2]) .. "'",
        "'${knl}' == '" .. tostring(s.knl[3]) .. "'",
        "'${knl}' == '" .. tostring(s.knl[4]) .. "'",
        "'${knl}' == '" .. tostring(s.knl[5]) .. "'",
        "'${knl}' == '" .. tostring(s.knl[6]) .. "'",
        "'${knl}' == '" .. tostring(s.knl[7]) .. "'",
      },
      legend = {
        y1 = "knl = \\{" .. tostring(s.knl[1]) .. "\\}",
        y2 = "knl = \\{" .. tostring(s.knl[2]) .. "\\}",
        y3 = "knl = \\{" .. tostring(s.knl[3]) .. "\\}",
        y4 = "knl = \\{" .. tostring(s.knl[4]) .. "\\}",
        y5 = "knl = \\{" .. tostring(s.knl[5]) .. "\\}",
        y6 = "knl = \\{" .. tostring(s.knl[6]) .. "\\}",
        y7 = "knl = \\{" .. tostring(s.knl[7]) .. "\\}",
      },
      title  = "Multipole NG vs PTC tilt, no lrad, order " .. ref_cfg.order,
      xlabel = "tilt [pi/8]",
      filename = "mult-body.png",
      xrange = {-0.1, 4.1},
    }
  }
  run_test(cfg)
end

local function testMULTs() -- Test multipole (1 min)
  local cfg = ref_cfg "mults" {
    elm =  [[
      MULTIPOLE, at=0.75, lrad=1.5,
      knl=${knl}, ksl=${ksl}, ksi=${ksi}
    ]],
    
    tol = 5500, -- Large error at knl == ksl == {0, 0, 0, 50} order 6
    
    energy = {1},
    model  = {1}, 
    method = {2, 6},
    nslice = {1, 2},

    knl = {
      {0   , 0  , 0, 0 }, 
      {0.05, 0  , 0, 0 },
      {0   , 0.5, 0, 0 }, 
      {0   , 0  , 5, 0 }, 
      {0   , 0  , 0, 50},
      {0   , 0.5, 5, 50},
    },
    ksi   = {-0.2, 0, 0.25},
    ksl   = \s-> s.knl,
    alist = tblcat(ref_cfg.alist, {"knl", "ksl", "ksi"}),

    plot_info = \s ->{
      x_axis_attr = "${ksi}",
      series = {
        "'${knl}' == '" .. tostring(s.knl[1]) .. "'",
        "'${knl}' == '" .. tostring(s.knl[2]) .. "'",
        "'${knl}' == '" .. tostring(s.knl[3]) .. "'",
        "'${knl}' == '" .. tostring(s.knl[4]) .. "'",
        "'${knl}' == '" .. tostring(s.knl[5]) .. "'",
        "'${knl}' == '" .. tostring(s.knl[6]) .. "'",
      },
      legend = {
        y1 = "knl = \\{" .. tostring(s.knl[1]) .. "\\}",
        y2 = "knl = \\{" .. tostring(s.knl[2]) .. "\\}",
        y3 = "knl = \\{" .. tostring(s.knl[3]) .. "\\}",
        y4 = "knl = \\{" .. tostring(s.knl[4]) .. "\\}",
        y5 = "knl = \\{" .. tostring(s.knl[5]) .. "\\}",
        y6 = "knl = \\{" .. tostring(s.knl[6]) .. "\\}",
      },
      title  = "Multipole NG vs PTC ksi, lrad, order " .. ref_cfg.order,
      xlabel = "ksi",
      filename = "mult-solenoid.png",
      xrange = {-0.21, 0.26},
    }
  }
  run_test(cfg)
end

testMULT()
testMULTs()