-- ../mad test-sbend-maps.mad
-- assume ../madx64 to be present...

local object                                                    in MAD
local tblcat                                                    in MAD.utility
local run_test in require("trackvsptc")

-- The setup for the tests ----------------------------------------------------o

local ref_cfg = object "ref" {
  -- How to run the tests
  dorun  = false, -- Default: true 
  dosave = true, -- Default: false
  doprnt = true, -- Default: false
  dodbg  = true, -- Default: false
  doplot = true, -- Default: false
  
  -- list of variables in the tests
  alist = {"model", "energy", "method", "nslice", "x0i"}, --attributes list
  tol = 1000,

  -- list of values that are used to run test but are not changed throughout
  order  = 4,        -- 2/4
  icase  = 56,       -- 56/6
  debug  = 0,        -- 0/6

  x0i    = 1..4,       -- 0, 4D, 5D, 6D (see get_mad_str)
}

local function testSBEND()
  local cfg = ref_cfg "sbend" {
    elm =  [[
      SBEND, at=0.75, l=1.5, k0=(pi/1.5/${angle})*${k0}, angle=pi/${angle}, 
      kill_ent_fringe=true, kill_exi_fringe=true;
    ]],

    tol = 91000,
    
    model  = 1..2,
    method = 2..6..2,    
    nslice = 1..3,
    energy = {1, 6500},

    alist  = tblcat(ref_cfg.alist, {"angle", "k0"}), 
    k0     = {1, 0.8, 1.2},
    angle = {10, 100, 1000, 10000},
    plot_info = {
      x_axis_attr = "math.pi/${angle}/${nslice}",
      title       = "SBend Body Comparison",
      series      = {"${model} == 1", "${model} == 2"},
      legend      = {y1 = "DKD"     , y2 = "TKT"     },
      xlabel      = "Angle per slice [rad]",
      xrange      = {7e-5, 1},
      plotcfg     = "set logscale x;"
    }
  }
  run_test(cfg)
end

local function testSBENDfr()
  local cfg = ref_cfg "sbendfr" {
    elm =  [[
      SBEND, at=0.75, l=1.5, angle=pi/100, tilt=${tilt}*pi/8, fringe=${fringe},
      kill_ent_fringe=${no_fringe}, kill_exi_fringe=${no_fringe};
    ]],

    tol = 10,
    model  = {1},
    method = {2},    
    nslice = {1},
    energy = {1},
    
    alist = tblcat(ref_cfg.alist, {"fringe", "no_fringe", "tilt"}), 
    no_fringe = {true, false},
    fringe    = {1, 7},
    tilt      = 0..4,

    plot_info = {
      x_axis_attr = "${tilt}",
      xrange      = {-0.1, 4.1},
    }
  }
  run_test(cfg)
end

local function testSBENDfe() -- Interesting -> e1 = Â±0.3 and e2 ~= 0 > 100 eps at low order.
  local cfg = ref_cfg "sbendfe" {
    elm =  [[
      SBEND, at=0.75, l=1.5, angle=${k0}*2*pi/1e2, 
      e1=${e1}*2*pi/1e2, e2=${e2}*2*pi/1e2,
      kill_ent_fringe=${no_fringe}, kill_exi_fringe=${no_fringe};
    ]],

    tol = 500,
    model  = {1},
    method = {2},    
    nslice = {1},
    energy = {1},
    
    alist = tblcat(ref_cfg.alist, {"k0", "no_fringe", "e2", "e1"}), 
    k0        = {0.5},
    no_fringe = {true, false},
    e1        = {-0.5, -0.3, -0.1, 0, 0.1, 0.3, 0.5},
    e2        = \s-> s.e1,
  }
  run_test(cfg)
end

local function testSBENDfh()
  local cfg = ref_cfg "sbendfh" {
    elm =  [[
      SBEND, at=0.75, l=1.5, angle=${k0}*2*pi/1e2, 
      e1=${e1}*2*pi/1e2, e2=${e2}*2*pi/1e2, hgap=${hgap}, fint=${fint},
      kill_ent_fringe=${no_fringe}, kill_exi_fringe=${no_fringe};
    ]],

    tol = 500,
    model  = {1},
    method = {2},    
    nslice = {1},
    energy = {1},
    
    alist = tblcat(ref_cfg.alist, {"k0", "no_fringe", "e2", "e1", "hgap", "fint"}), 
    k0        = {0.5},
    no_fringe = {true, false},
    e1        = {-0.3, 0, 0.1},
    e2        = \s-> s.e1,
    hgap     = {0, 0.02, 0.03},
    fint     = {0, 0.7, 0.8},

  }
  run_test(cfg)
end

local function testSBENDfhs() -- knl required so MAD-NG and PTC use the same coefficients (MAD-NG has access to a few more coefficients that PTC ignores)
  local cfg = ref_cfg "sbendfhs" {
    elm =  [[
      SBEND, at=0.75, l=1.5, angle=${k0}*2*pi/1e2, k1=${k1}, k1s=${k1s}, !knl={0,0,0,0,0},
      e1=${e1}*2*pi/2.2e2, e2=${e2}*2*pi/2.5e2, hgap=${hgap}, fint=${fint},
      kill_ent_fringe=${no_fringe}, kill_exi_fringe=${no_fringe};
    ]],

    tol = 500,
    model  = {1, 2},
    method = {2},    
    nslice = {1},
    energy = {1},
    
    alist = tblcat(
      ref_cfg.alist, 
      {"k0", "no_fringe", "e2", "e1", "hgap", "fint", "k1s", "k1"}
    ), 
    k0        = {0.5},
    no_fringe = {true, false},
    e1        = {-0.3, 0, 0.1},
    e2        = \s-> s.e1,
    hgap      = {0, 0.05},
    fint      = {0, 0.7},
    k1        = {0, -0.15, 0.2},
    k1s       = \s-> s.k1,

  }
  run_test(cfg)
end

testSBEND()
testSBENDfr()