-- ../mad test-misc-maps.mad
-- assume ../madx64 to be present...

local object                                                    in MAD
local tblcat                                                    in MAD.utility
local run_test in require("trackvsptc")

-- The setup for the tests ----------------------------------------------------o

local ref_cfg = object "ref" {
  -- How to run the tests
  dorun  = true, -- Default: true 
  dosave = true, -- Default: false
  doprnt = false, -- Default: false
  dodbg  = false, -- Default: false
  doplot = true, -- Default: false
  
  -- list of variables in the tests
  alist = {"model", "energy", "method", "nslice", "x0i"}, --attributes list
  tol = 1000,

  -- list of values that are used to run test but are not changed throughout
  order  = 4,        -- 2/4
  icase  = 56,       -- 56/6
  debug  = 0,        -- 0/6
  snm    = -1,

  x0i    = 1..4,       -- 0, 4D, 5D, 6D (see get_mad_str)
}

local function testDRIFT()
  local cfg = ref_cfg "drift" { 
    elm = "DRIFT, at=${at}, l=${l}, tilt=${tilt}*pi/8;",
    
    model  = {1},
    method = {2},    
    nslice = {1},
    energy = {1, 6500},  -- {1, 450, 6500}

    tol = 100,

    l     = {0.1, 0.5, 1.5, 1.99},
    at    = \s->{s.cur_cfg.l/2},
    tilt  = 0..4, 
    alist = tblcat(ref_cfg.alist, {"l", "at", "tilt"}),

    plot_info = {
      x_axis_attr = "${l}",
      series = {
        "${tilt} == 0", 
        "${tilt} == 1",
        "${tilt} == 2",
        "${tilt} == 3",
        "${tilt} == 4",
      },
      legend = {
        y1 = "Tilt = 0",
        y2 = "Tilt = pi/8",
        y3 = "Tilt = pi/4",
        y4 = "Tilt = 3pi/8",
        y5 = "Tilt = pi/2",
      },
      title = "Drift NG vs PTC",
      xlabel = "Drift Length [m]",
      filename = "drift.png",
      xrange = {0, 2},
    }
  }
  run_test(cfg)
end

local function testELSEP()
  local cfg = ref_cfg "elseparator" {
    elm =  [[
      ELSEPARATOR, at=0.75, l=1.5, 
      ex=${ex}, ey=${ey}, ex_l=${ex_l}, ey_l=${ey_l}, tilt=${tilt}*pi/16;
    ]],

    model  = {1},
    method = {2, 8},    
    nslice = 1..3,
    energy = {1, 6500},  -- {1, 450, 6500}

    tol = 1000,

    alist = tblcat(ref_cfg.alist, {"ex", "ey", "ex_l", "ey_l", "tilt"}),
    ex       = {-4, 4},
    ey       = {-4, 4},
    ex_l     = -6..6..6, ! Madx is ex_l and the madng is exl
    ey_l     = -6..6..6, ! Madx is ex_l and the madng is exl
    tilt     = 0..2, 

    plot_info = {
      series = {
        "${nslice} == 1",
        "${nslice} == 2",
        "${nslice} == 3",
      },
      legend = {
        y1 = "nslice = 1",
        y2 = "nslice = 2",
        y3 = "nslice = 3",
      },
      title = "Electrostatic Separator NG vs PTC",
      filename = "elseparator.png",
    }
  }
  run_test(cfg)
end

local function testKICK()
  local cfg = ref_cfg "kicker" {
    elm =  [[
      KICKER, at=0.75, l=1.5, 
      hkick=${hkick}, vkick=${vkick}, tilt=${tilt}*pi/16;
    ]],

    model  = 1..2,
    method = 2..8..2,    
    nslice = 1..3,
    energy = {1, 6500},  -- {1, 450, 6500}

    tol = 1000,

    alist = tblcat(ref_cfg.alist, {"hkick", "vkick", "tilt"}), 
    hkick    = -2e-3..2e-3..2e-3,
    vkick    = -2e-3..2e-3..2e-3,
    tilt     = 0..3,
    
    plot_info = {
      series = {
        "${tilt} == 0",
        "${tilt} == 1",
        "${tilt} == 2",
        "${tilt} == 3",
      },
      legend = {
        y1 = "Tilt = 0",
        y2 = "Tilt = pi/16",
        y3 = "Tilt = pi/8",
        y4 = "Tilt = 3pi/16",
      },
      title = "Kicker NG vs PTC",
      filename = "kicker.png",
    }
  }
  run_test(cfg)
end

testDRIFT()
testELSEP()
testKICK()