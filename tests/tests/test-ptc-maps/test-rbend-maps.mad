-- ../mad test-rbend-maps.mad
-- assume ../madx64 to be present...

local object                                                    in MAD
local tblcat                                                    in MAD.utility
local run_test in require("trackvsptc")

-- The setup for the tests ----------------------------------------------------o

local ref_cfg = object "ref" {
  -- How to run the tests
  dorun  = true, -- Default: true 
  dosave = true, -- Default: false
  doprnt = false, -- Default: false
  dodbg  = true, -- Default: false
  doplot = true, -- Default: false
  
  -- list of variables in the tests
  alist = {"model", "energy", "method", "nslice", "x0i"}, --attributes list
  tol = 1000,

  -- list of values that are used to run test but are not changed throughout
  order  = 4,        -- 2/4
  icase  = 56,       -- 56/6
  debug  = 0,        -- 0/6
  snm    = -1,

  x0i    = 1..4,       -- 0, 4D, 5D, 6D (see get_mad_str)
}

local function testRBEND()
  local cfg = ref_cfg "rbend"{
    elm =  [[
      RBEND, at=0.75, l=1.5, angle=${k0}*2*pi/1e2,
      kill_ent_fringe=${no_fringe}, kill_exi_fringe=${no_fringe},
      ptcrbend=true, truerbend=true;
    ]],
    model  = 1..2,
    method = 2..8..2,    
    nslice = 1..3,
    energy = {1, 6500},  -- {1, 450, 6500}
    order = 4,

    tol = 2000,

    alist = tblcat(ref_cfg.alist, {"k0", "no_fringe"}),
    k0        = -0.5..0.5..0.2,
    no_fringe = {true, false},

    plot_info = {
      x_axis_attr = "(${k0}*2*math.pi/1e2)/${nslice}",
      title       = "RBend Body Comparison",
      series      = {"${model} == 1", "${model} == 2"},
      legend      = {y1 = "DKD"     , y2 = "TKT"     },
      xlabel      = "Angle per slice [rad]",
      -- xrange      = {7e-5, 1},
      plotcfg     = "set logscale x;",
      filename    = "rbend-body-comparison.png",
    }
  }
  run_test(cfg)
end

local function testRBENDfr()
  local cfg = ref_cfg "rbendfr"{
    elm = [[
      RBEND, at=0.75, l=1.5, angle=${k0}*2*pi/1e2, tilt=${tilt}*pi/8,
      kill_ent_fringe=${no_fringe}, kill_exi_fringe=${no_fringe},
      ptcrbend=true, truerbend=true;
    ]],
    tol = 2000,
    model  = {1},
    method = {2},    
    nslice = {1},
    energy = {1},
    
    alist = tblcat(ref_cfg.alist, {"k0", "no_fringe", "tilt"}), 
    k0        = {0.5},
    no_fringe = {true, false},
    tilt      = 0..4,

    plot_info = {
      x_axis_attr = "${tilt}",
      xlabel      = "Tilt [pi/8]",
      title       = "RBend Fringe Comparison",
      xrange      = {-0.1, 4.1},
      filename    = "rbend-fringe-comparison.png",
    }
  }
  run_test(cfg)
end

local function testRBENDfe() -- Fails when e1 or e2 != 0, see problems.md 
  local cfg = ref_cfg "rbendfe"{
    elm = [[
      RBEND, at=0.75, l=1.5, angle=${k0}*2*pi/1e2, e1=${e1}*2*pi/1e2, e2=${e2}*2*pi/1e2,
      kill_ent_fringe=${no_fringe}, kill_exi_fringe=${no_fringe},
      ptcrbend=true, truerbend=true;
    ]],
    tol = 2000,
    model  = {1},
    method = {2},    
    nslice = {1},
    energy = {1},
    
    alist = tblcat(ref_cfg.alist, {"k0", "no_fringe", "e2", "e1"}), 
    k0        = {0.5},
    no_fringe = {true, false},
    e2        = {-0.3, 0, 0.1},
    e1        = {0, 0.2},

    plot_info = {
      x_axis_attr = "${e2}",
      xrange      = {-0.35, 0.15},
      title       = "RBend Face Comparison",
      series      = { "${e1} == 0", "${e1} == 0.2" },
      legend      = {y1 = "e1 = 0", y2 = "e1 = 0.2"},
      filename    = "rbend-face-comparison.png",
    }

  }
  run_test(cfg)
end

local function testRBENDfh() -- E1 and E2 are modified by MAD-X for rbend to work.
  local cfg = ref_cfg "rbendfh"{
    elm = [[
      RBEND, at=0.75, l=1.5, angle=${k0}*2*pi/1e2, 
      hgap=${hgap}, fint=${fint}, fintx=${fintx}, 
      kill_ent_fringe=${no_fringe}, kill_exi_fringe=${no_fringe},
      ptcrbend=true, truerbend=true;
    ]],! e1=${e1}*2*pi/1e2, e2=${e2}*2*pi/1e2,
    tol = 2000,
    model  = {1},
    method = {2},    
    nslice = {1},
    energy = {1},
    
    alist = tblcat(
      ref_cfg.alist, 
      {"k0", "no_fringe", "hgap", "fint", "fintx"--[[ , "e1", "e2" ]]}
    ), 

    k0        = {0.5},
    no_fringe = {true, false},
    hgap      = {0, 0.05},
    fint      = {0, 0.7},
    fintx     = \s -> s.fint,
    -- e2        = {0, 0.1, -0.3},
    -- e1        = {0},

    plot_info = {
      x_axis_attr = "${fint}",
      xrange      = {-0.01, 0.71},
      series      = { "${fintx} == 0", "${fintx} == 0.7" },
      legend      = {y1 = "fintx = 0", y2 = "fintx = 0.7"},
      title       = "RBend Fringe and Face Comparison",
      filename    = "rbend-fringe-face-comparison.png",
    }
  }
  run_test(cfg)
end

local function testRBENDfhs() -- E1 and E2 are modified by MAD-X for rbend to work.
  local cfg = ref_cfg "rbendfhs"{
    elm = [[
      RBEND, at=0.75, l=1.5, angle=${k0}*2*pi/1e2, k1 = ${k1},
      hgap=${hgap}, fint=${fint}, fintx=${fintx}, f1=${f1}, f2=${f2},
      kill_ent_fringe=${no_fringe}, kill_exi_fringe=${no_fringe},
      ptcrbend=true, truerbend=true;
    ]], ! e1=${e1}*2*pi/1e2, e2=${e2}*2*pi/1e2,
    tol = 2000,
    model  = {1},
    method = {2},    
    nslice = {1},
    energy = {1},
    
    alist = tblcat(
      ref_cfg.alist,
      {"k0", "no_fringe", "hgap", "fint", "fintx",--[[  "e1", "e2",  ]]"k1", "f1", "f2"}
    ), 
    k0        = {0.5},
    k1        = {0, 0.5},
    no_fringe = {true, false},
    hgap      = {0, 0.05},
    fint      = {0, 0.7},
    fintx     = {0, 0.7},
    f1        = {0, 0.3},
    f2        = {0, 0.8},
    -- e2        = {0, 0.1, -0.3},
    -- e1        = {0}, 

    plot_info = {
      x_axis_attr = "${fint}",
      xrange      = {-0.01, 0.71},
      series      = { "${fintx} == 0", "${fintx} == 0.7" },
      legend      = {y1 = "fintx = 0", y2 = "fintx = 0.7"},
      title       = "RBend Fringe and Face with k1 Comparison",
      filename    = "rbend-fringe-face-k1-comparison.png",
    }
  }
  run_test(cfg)
end

testRBEND()
testRBENDfr()
testRBENDfe()
testRBENDfh()
testRBENDfhs()
