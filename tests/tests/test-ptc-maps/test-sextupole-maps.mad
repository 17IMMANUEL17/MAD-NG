-- ../mad test-sext-maps.mad
-- assume ../madx64 to be present...

local object, tostring                                          in MAD
local tblcat                                                    in MAD.utility
local run_test in require("trackvsptc")

-- The setup for the tests ----------------------------------------------------o

local ref_cfg = object "ref" {
  -- How to run the tests
  dorun  = true, -- Default: true 
  dosave = true, -- Default: false
  doprnt = true, -- Default: false
  dodbg  = true, -- Default: false
  doplot = true, -- Default: false
  
  -- list of variables in the tests
  alist = {"model", "energy", "method", "nslice", "x0i"}, --attributes list
  tol = 1000,

  -- list of values that are used to run test but are not changed throughout
  order  = 4,        -- 2/4
  icase  = 56,       -- 56/6
  debug  = 0,        -- 0/6
  snm    = -1,

  x0i    = 1..4,       -- 0, 4D, 5D, 6D (see get_mad_str)
}

-- The tests ------------------------------------------------------------------o
local function testSEXT() -- Test the body (~2 min)
  local cfg = ref_cfg "sext" {
    elm = "SEXTUPOLE, at=0.75, l=1.5, k2=${k2}, k2s=${k2s}, fringe=0",
    model  = 1..2,
    method = 2..8..2,    
    nslice = 1..3,
    energy = {1, 6500},  -- {1, 450, 6500}

    tol = 120,

    k2     = {-0.15, 0, 0.2},
    k2s    = {-0.15, 0, 0.2},
    alist = tblcat(ref_cfg.alist, {"k2", "k2s"}),

    plot_info = {
      x_axis_attr = "${k2}",
      title       = "Sextupole Body Comparison",
      series      = {
        "${method} == 2",
        "${method} == 4",
        "${method} == 6",
        "${method} == 8",
      },
      legend      = {
        y1 = "Method 2",
        y2 = "Method 4",
        y3 = "Method 6",
        y4 = "Method 8",
      },
      xrange      = {-0.2, 0.25},
      filename = "sext-body-comparision.png",
    }
  }
  run_test(cfg)
end

-- NOTE: FAILS for knl[2] ~= 0 or ksl[2] ~= 0
local function testSEXTm() -- Test the multipole (~2 min)
  local cfg = ref_cfg "sextm" {
    elm = [[
      SEXTUPOLE, at=0.75, l=1.5, k2=${k2}, k2s=${k2s}, tilt=${tilt}*pi/12,
      knl=${knl}, ksl=${ksl}, fringe=7, bend_fringe=true,
    ]],
    
    tol = 300,

    model  = {1}, 
    method = {2},
    nslice = {1},
    energy = {1},       

    k2   = {0, 0.2},  -- Test just multipole first
    k2s  = \s->s.k2, !{0, -0.15, 0.2},  -- Test just multipole first
    knl  = {
      { }, 
      {0.05, 0  , 0, 0 }, ! MAD-X ignores knl[1], ksl[1]
      {0   , 0.5, 0, 0 },
      {0   , 0  , 5, 0 }, 
      {0   , 0  , 0, 50},
      {0.05, 0.5, 5, 50}, ! MAD-X ignores knl[1], ksl[1]
      {0   , 0  , 5, 50},
    },
    ksl  = \s-> s.knl,
    tilt = 0..2,
    alist = tblcat(ref_cfg.alist, {"tilt", "k2s", "k2", "ksl", "knl"}),

    plot_info = \s-> {
      series = {
        "'${knl}' == '" .. tostring(s.knl[1]) .. "'",
        "'${knl}' == '" .. tostring(s.knl[2]) .. "'",
        "'${knl}' == '" .. tostring(s.knl[3]) .. "'",
        "'${knl}' == '" .. tostring(s.knl[4]) .. "'",
        "'${knl}' == '" .. tostring(s.knl[5]) .. "'",
        "'${knl}' == '" .. tostring(s.knl[6]) .. "'",
        "'${knl}' == '" .. tostring(s.knl[7]) .. "'",
      },
      legend = {
        y1 = "knl = \\{" .. tostring(s.knl[1]) .. "\\}",
        y2 = "knl = \\{" .. tostring(s.knl[2]) .. "\\}",
        y3 = "knl = \\{" .. tostring(s.knl[3]) .. "\\}",
        y4 = "knl = \\{" .. tostring(s.knl[4]) .. "\\}",
        y5 = "knl = \\{" .. tostring(s.knl[5]) .. "\\}",
        y6 = "knl = \\{" .. tostring(s.knl[6]) .. "\\}",
        y7 = "knl = {" .. tostring(s.knl[7]) .. "}",
      },
      title = "Sextupole Multipole Comparison",
      filename = "sext-mult-comparision.png",
    }
  }
  run_test(cfg)
end

local function testSEXTf() -- Test the fringe (~1 min)
  local cfg = ref_cfg "sextf" {
    elm = [[
      SEXTUPOLE, at=0.75, l=1.5, k2=${k2}, k2s=${k2s}, tilt=${tilt}*pi/12,
      fringe=${fringe}
    ]],
    
    tol = 25,

    model  = {1}, 
    method = {2},    
    nslice = {1},
    energy = {1},

    tilt   = 0..4,
    fringe = {0, 7},
    k2   = {0, 0.2},
    k2s  = \s->s.k2,
    alist = tblcat(ref_cfg.alist, {"tilt", "fringe", "k2", "k2s"}),

    plot_info = {
      x_axis_attr = "${tilt}",
      title       = "Sextupole Fringe Comparison",
      series      = {
        "${k2} == 0",
        "${k2} == 0.2",
      },
      legend      = {
        y1 = "k2 = 0",
        y2 = "k2 = 0.2",
      },
      x_label     = "tilt [pi/12]",
      xrange      = {-0.1, 4.1},
      filename    = "sext-fringe-comparision.png",
    }
  }
  run_test(cfg)
end

local function testSEXTh()
  local cfg = ref_cfg "sexth" {
    elm = [[
      SEXTUPOLE, at=0.75, l=1.5, k2=${k2}, k2s=${k2s}, tilt=${tilt}*pi/12,
      knl={${k0}}
    ]],
    
    tol = 25,
    
    model  = {1}, -- Use DKD as otherwise PTC broken
    method = {2},    
    nslice = {1},
    energy = {1},

    tilt   = 0..4,
    k2     = {0, 0.2},
    k2s    = \s->s.k2,
    k0     = {-0.05, 0, 0.05},
    
    alist = tblcat(ref_cfg.alist, {"tilt", "k2", "k2s", "k0"}),

    plot_info = {
      x_axis_attr = "${tilt}",
      title       = "Sextupole with k0 Comparison",
      series      = {
        "${k0} == -0.05",
        "${k0} == 0",
        "${k0} == 0.05",
      },
      legend      = {
        y1 = "k0 = -0.05",
        y2 = "k0 = 0",
        y3 = "k0 = 0.05",
      },
      x_label     = "tilt [pi/12]",
      xrange      = {-0.1, 4.1},
      filename    = "sext-k0-comparision.png",
    }
  }
  run_test(cfg)
end

local function testSEXTfh() -- MAD-NG does bend fringe for fringe=3
  local cfg = ref_cfg "sextfh" {
    elm = [[
      SEXTUPOLE, at=0.75, l=1.5, k2=${k2}, k2s=${k2s}, fringe=${fringe},
      knl={${k0}}, bend_fringe=true
    ]],
    
    tol = 25,
    
    model  = {1}, -- Use DKD as otherwise PTC broken
    method = {2},
    nslice = {1},
    energy = {1},

    fringe      = {7},
    k2          = {0, 0.2},
    k2s         = \s->s.k2,
    k0          = {0, 0.05},
    alist = tblcat(ref_cfg.alist, {"k2", "k2s", "k0", "fringe"}),

    plot_info = {
      x_axis_attr = "${k2}",
      title       = "Sextupole with k0 and fringe Comparison",
      series      = {
        "${k0} == 0",
        "${k0} == 0.05",
      },
      legend      = {
        y1 = "k0 = 0",
        y2 = "k0 = 0.05",
      },
      xrange      = {-0.01, 0.21},
      filename    = "sext-k0-fringe-comparision.png",
    
    }
  }
  run_test(cfg)
end

testSEXT()
testSEXTm()
testSEXTf()
testSEXTh()
testSEXTfh()