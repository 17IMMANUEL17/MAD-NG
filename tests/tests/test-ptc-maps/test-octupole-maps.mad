-- ../mad test-sbend-maps.mad
-- assume ../madx64 to be present...

local object                                                    in MAD
local tblcat                                                    in MAD.utility
local run_test in require("trackvsptc")

-- The setup for the tests ----------------------------------------------------o

local ref_cfg = object "ref" {
  -- How to run the tests
  dorun  = false, -- Default: true 
  dosave = true, -- Default: false
  doprnt = false, -- Default: false
  dodbg  = false, -- Default: false
  doplot = true, -- Default: false
  
  -- list of variables in the tests
  alist = {"model", "energy", "method", "nslice", "x0i"}, --attributes list
  tol = 1000,

  -- list of values that are used to run test but are not changed throughout
  order  = 4,        -- 2/4
  icase  = 56,       -- 56/6
  debug  = 0,        -- 0/6
  snm    = -1,

  x0i    = 1..4,       -- 0, 4D, 5D, 6D (see get_mad_str)
}

local function testOCT()
  local cfg = ref_cfg "oct" {
    elm = "OCTUPOLE, at=0.75, l=1.5, k3=${k3}, k3s=${k3s}",

    tol = 50,
    model  = 1..2,
    method = 2..6..2,    
    nslice = 1..3,
    energy = {1, 6500},  -- {1, 450, 6500}

    k3     = {-0.2, 0, 0.3},
    k3s    = \s-> s.k3,
    alist = tblcat(ref_cfg.alist, {"k3", "k3s"}),

    plot_info = {
      title  = "Octupole NG vs PTC k3 and k3s",
      series      = {"${model} == 1", "${model} == 2"},
      legend      = {y1 = "DKD"     , y2 = "TKT"     },
      x_axis_attr = "${k3}",
      xrange      = {-0.25, 0.35},
    }
  }
  run_test(cfg)
end
  
local function testOCTfr()
  local cfg = ref_cfg "octfr" {
    elm = [[
      OCTUPOLE, at=${length}/2, l=${length}, 
      k3=${k3}, k3s=${k3s}, tilt=${tilt}*pi/16, fringe=${fringe}
    ]],

    tol = 50,

    model  = {1},
    method = {2},    
    nslice = {1},
    energy = {1}, 

    tilt   = 0  ..8..2,
    fringe = 0  ..7 ..7,
    k3     = {0, 0.2},
    k3s    = \s-> s.k3,
    length = {0.1, 0.5, 0.75, 1.0, 1.5, 1.99, 2.0},
    alist = tblcat(ref_cfg.alist, {"tilt", "fringe", "k3", "k3s", "length"}),
    plot_info = {
      x_axis_attr = "${tilt}",
      series = {
        "${length} == 0.1", "${length} == 0.5", "${length} == 0.75",
        "${length} == 1.0", "${length} == 1.5", "${length} == 1.99",
        "${length} == 2.0",
      },
      title  = "Octupole NG vs PTC tilt, fringe and length",
      xlabel = "tilt [pi/16]",
      xrange = {-0.1, 8.1},
    }
  }
  run_test(cfg)
end

testOCT()
testOCTfr()