!-------------------------------------------------------------------------------
! Remove install old and new elements
! Triplets, interconnection lenghts and MS postions are defined
! by the calling program
! ------------------------------------------------------------------------------

local print, ipairs in _G

-- LHCB2 as LHCB4
bv_aux = mylhcbeam > 2 and -1 or 1
lhcb2  = mylhcbeam > 2 and lhcb2:reflect() or lhcb2 ! guessed!

if on_layout_custom == 0 then
  l_mqxfa       =   4.200
  l_mqxfb       =   7.150
  dq1aq1b       =   0.606 -0.014 !-0.04 from V1.2
  dq1q2a        =   3.628 +0.005
  dq2aq2b       =   2.108 +0.004
  dq2bq3        =   3.628 +0.005
  deltaposd2    = -15.805   !max. field D2 35.1 Tm
  deltaposq4    =  10.500
  deltaposq5    =  10.500
  deltaposq6    =   0
  deltaposcrab  =   0
  deltaposmcbrd =   0
  deltapostaxn  =   0
  on_cutms_10f  =   0
  on_cutms_14f  =   0
  on_cutms_10d  =   0
  on_cutms_14d  =   0
  l_mbxf        =   6.27
  l_mcbxfb      =   1.2
  l_mcbxfa      =   2.2
  l_mbrd        =   7.778
  l_mcbrd       =   1.930
end

!print(l_mqxl,l_mqx,dq1q2a,dq2aq2b,dq2bq3)
!print(deltaposD2)
!print(deltaposQ4)
!print(deltaposQ5)
!print(deltaposQ6)

!===============================================
! REMOVE CURRENT INSERTION (from TAS to Q6)
!===============================================

brho = 23348.89927

posmarke =15
!posmarks=163  ! include D2
!posmarks=184  ! include Q4
!posmarks=240  ! include Q6
posmarks =259  ! include Q6 DFBAJ DFBAI

local selected in MAD.element.flags

-- LHCB1 -----------------------------o

if bv_aux == 1 then
  lhcb1:deselect()
  lhcb1:select {-posmarks,-posmarke,'IP1.L1' }
  lhcb1:select { posmarke, posmarks,'IP1'    }
  lhcb1:select {-posmarks,-posmarke,'IP5'    }
  lhcb1:select { posmarke, posmarks,'IP5'    }
  lhcb1:select { class = brana    }  -- useless!
  lhcb1:select { class = x1fcl    }  -- useless!
  lhcb1:select { class = x1fcr    }  -- useless!
  lhcb1:select { class = x1zdc001 }  -- not installed!
  lhcb1:select { class = x5zdc001 }  -- not installed!
  lhcb1:select { class = x5zdc002 }  -- not installed!

  for _,e in ipairs {
    'MCBCH.10L1.B1', 'MCBCV.10R1.B1', 'MCBCH.10L5.B1', 'MCBCV.10R5.B1',
    'MS.10L1.B1'   , 'MS.10R1.B1'   , 'MS.10L5.B1'   , 'MS.10R5.B1'   ,    -- not installed!
    'MCBH.10L1.B1' , 'MCBV.10R1.B1' , 'MCBH.10L5.B1' , 'MCBV.10R5.B1' } do -- not installed!
    if lhcb1[e] then lhcb1[e]:select() end
  end

  local elm_r, idx_r = lhcb1:remove {flag=selected}
--print(#elm_r, #idx_r, #lhcb1)
end

-- LHCB2/LHCB4 -----------------------o

local posmarks2 = bv_aux > 0 and posmarks or posmarke -- swap positions for lhcb4
local posmarke2 = bv_aux > 0 and posmarke or posmarks

!print(bv_aux,-posmarks2*bv_aux,-posmarke2*bv_aux)

lhcb2:deselect()
lhcb2:select {-posmarks2*bv_aux,-posmarke2*bv_aux,'IP1.L1'}
lhcb2:select { posmarke2*bv_aux, posmarks2*bv_aux,'IP1'   }
lhcb2:select {-posmarks2*bv_aux,-posmarke2*bv_aux,'IP5'   }
lhcb2:select { posmarke2*bv_aux, posmarks2*bv_aux,'IP5'   }
lhcb2:select { class = brana    }  -- useless!
lhcb2:select { class = x1fcl    }  -- useless!
lhcb2:select { class = x1fcr    }  -- useless!
lhcb2:select { class = x1zdc001 }  -- not installed!
lhcb2:select { class = x5zdc001 }  -- not installed!
lhcb2:select { class = x5zdc002 }  -- not installed!

for _,e in ipairs {
  'MCBCV.10L1.B2', 'MCBCH.10R1.B2', 'MCBCV.10L5.B2', 'MCBCH.10R5.B2',
  'MS.10L1.B2'   , 'MS.10R1.B2'   , 'MS.10L5.B2'   , 'MS.10R5.B2'   ,    -- not installed!
  'MCBV.10L1.B2' , 'MCBH.10R1.B2' , 'MCBV.10L5.B2' , 'MCBH.10R5.B2' } do -- not installed!
  if lhcb2[e] then lhcb2[e]:select() end
end

local elm_r, idx_r = lhcb2:remove {flag=selected}
--print(#elm_r, #idx_r, #lhcb2)
