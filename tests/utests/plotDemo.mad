--[=[
 o-----------------------------------------------------------------------------o
 |
 | Plot DEMO
 |
 | Methodical Accelerator Design - Copyright CERN 2016+
 | Support: http://cern.ch/mad  - mad at cern.ch
 | Authors: L. Deniau, laurent.deniau at cern.ch
 |          A.Z. Teska, aleksandra.teska at cern.ch
 |          A. Bloch, aurelien.bloch at cern.ch
 | Contrib: -
 |
 o-----------------------------------------------------------------------------o
 | You can redistribute this file and/or modify it under the terms of the GNU
 | General Public License GPLv3 (or later), as published by the Free Software
 | Foundation. This file is distributed in the hope that it will be useful, but
 | WITHOUT ANY WARRANTY OF ANY KIND. See http://gnu.org/licenses for details.
 o-----------------------------------------------------------------------------o
]=]

-- locals ---------------------------------------------------------------------o

local mtable, plot        in MAD
local observed            in MAD.element.flags
local pause               in MAD.utility
local pi, sin, cos        in math

local toolbox  = require 'toolbox'

local shrdir = \s -> '../share/'..s

local pln = arg[1] and tonumber(arg[1]) or 0

-- Initialization --------------------------------------------------------------

-- load LHC
local lhcb1, lhcb2 = toolbox.loadLHC()
lhcb1:select(observed)
lhcb2:select(observed)
local lhc = {lhcb1, lhcb2}

MADX:load(shrdir('LHC/opt_inj.mad'))

-- Dummy mtable
local mtbl = mtable { {'name'}, 'x', 'y', 'z' }
for i=0, 25000 do
  mtbl = mtbl + {'A' .. i, i, sin(i/(20*pi)), cos(i/(20*pi)) }
end

local function mypause(msg)
  local str = pause(msg..'\n', 'x')
--  if str == 'c' then close_plot() end
end

-- Examples --------------------------------------------------------------------

-- default cmd
local myplot = plot {
  table    = mtbl,
  x1y1     = { x = 'y'},
  exec     = false,
}

local sid = 0
local function newid()
  sid = sid + 1
  return sid
end

-- Basic plot
if pln <= 0 then
myplot {}
mypause('Basic plot')
end

-- Many plot options used
local option
if pln <= 1 then
options = plot {
    sid         = newid(),
--    scrdump     = "plot.gp",
    sequence    = lhcb1,
    range       = { 'E.DS.L5.B1', 'S.DS.R5.B1' },
    table       = mtbl,
    tablerange  = { 100, 400 },
    x1y1        = { x = { 'y', 'z' } },
    yrange      = { -1.2, 1.2 },
    colors      = { y = 'red',   z = 'green' },
    styles      = { y = "lines", z = "linespoints" },
    dashtypes   = { y = "..   ", z = "--  " },
    pointtypes  = {              z = 4 },
    legendfont  = "Times New Roman",
    legendsize  = 21,
    legendpos   = "top right",
    fontsize    = 22,
    legend      = {y = "{/Symbol b} + \u{03b2}", z = "{/Symbol B} + \u{0392}"},
    xlabel      = "Absciss label",
    ylabel      = "Ordinate label",
}
mypause('Many plot options used')
end

-- pdf multiplot
if pln <= 2 then
lhcb1:set_layangle(false)
lhcb2:set_layangle(false)
local multi1 = options {
    sid      = newid(),
    prolog   = "set multiplot",
    output   = "plot-multi.pdf",
    psizey   = 0.4,
}
local multi2 = myplot {
  sid        = multi1.sid,
  originy    = 0.4,
  psizey     = 0.4,
  psizex     = 0.5,
  output     = "plot-multi.pdf",
}
multi2 {
  epilog     = "unset multiplot\n unset out",
  originx    = 0.5,
}
mypause('PDF multiplot')
end

-- flat lhcb1
if pln <= 3 then
myplot {
  sid      = newid(),
  sequence = lhcb1,
  title    = "Flat lhcb1",
}
lhcb1:set_layangle(true)
lhcb2:set_layangle(true)
mypause('Flat lhcb1')
end

-- two flat beams
if pln <= 4 then
myplot {
  sid      = newid(),
  sequence = lhc,
  laydisty = 0.20,
  title    = "Two flat beams",
  layangle = false,
}
mypause('Two flat beams')
end

-- Two angled beam
if pln <= 5 then
myplot {
  sid      = newid(),
  sequence = lhc,
  title    = "Two angled beams",
}
mypause('Two angled beams')
end

-- Bottom two angled beam
if pln <= 6 then
myplot {
  sid      = newid(),
  sequence = lhc,
  laypos   = "bottom",
  title    = "Two angled beams at bottom",
}
mypause('Two angled beams at bottom')
end

-- 1-turn two angled beam
if pln <= 7 then
myplot {
  sid      = newid(),
  sequence = lhc,
  nturn    = 1,
  title    = "1-turn two angled beams",
}
mypause('1-turn of two angled beams')
end


-- IP1-IP5 two angled beam
local ip1_ip5
if pln <= 8 then
ip1_ip5 = myplot {
  sid      = newid(),
  sequence = { lhcb1, lhcb2, lhcb1, lhcb2 },
  range    = {
    {"E.DS.L1.B1", "S.DS.R1.B1"},{"E.DS.L1.B2", "S.DS.R1.B2"},
    {"E.DS.L5.B1", "S.DS.R5.B1"},{"E.DS.L5.B2", "S.DS.R5.B2"},
  },
  laydisty = {
    lhcb2["E.DS.L1.B2"].mech_sep,
    -0.4,
    -0.4 + lhcb2['E.DS.L5.B2'].mech_sep
  },
  title    = "IP1-IP5 two angled beams",
}
mypause('IP1-IP5 two angled beams')
end

if pln <= 9 then
-- IP1-IP5 two angled beam bigger
ip1_ip5 {
  sid     = newid(),
  laysize = 0.5,
  title   = "IP1-IP5 two angled beams bigger",
}
mypause('IP1-IP5 two angled beams bigger')
end

if pln <= 10 then
-- IP1-IP5 two angled beam layout only
ip1_ip5 {
  sid   = newid(),
  table = false,
}
mypause('IP1-IP5 two angled beams layout only')
end

if pln <= 11 then
-- IP1-IP5 two angled beam with script dump
ip1_ip5 {
  sid     = newid(),
  scrdump = "plot.gp",
  title   = "IP1-IP5 two angled beam with script dump",
}
mypause('IP1-IP5 two angled beams with script dump')
end

if pln <= 12 then
-- IP1-IP5 two angled beam in pdf
ip1_ip5 {
  sid    = newid(),
  output = "plot.pdf",
  epilog = "unset out",
  title  = "IP1-IP5 two angled beam in pdf",
}
mypause('IP1-IP5 two angled beams in pdf')
end

local in_plot
if pln <= 13 then
-- Layout in plot
in_plot = plot {
  prolog   = 'set size ratio -1',
  sid      = newid(),
  sequence = lhc,
  laypos   = "in",
  layonly  = false,
  title    = "Layout in plot",
  scrdump = "plotlhc.gp",
}
mypause('Layout in plot')
end

if pln <= 14 then
-- Layout in plot only
in_plot {
  sid    = newid(),
  table  = false,
}
mypause('Layout in plot only')
end
