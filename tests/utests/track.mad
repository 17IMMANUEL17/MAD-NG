--[=[
 o-----------------------------------------------------------------------------o
 |
 | Track tests
 |
 | Methodical Accelerator Design - Copyright CERN 2016+
 | Support: http://cern.ch/mad  - mad at cern.ch
 | Authors: L. Deniau, laurent.deniau at cern.ch
 | Contrib: I. Tecker, irina.tecker at cern.ch
 |
 o-----------------------------------------------------------------------------o
 | You can redistribute this file and/or modify it under the terms of the GNU
 | General Public License GPLv3 (or later), as published by the Free Software
 | Foundation. This file is distributed in the hope that it will be useful, but
 | WITHOUT ANY WARRANTY OF ANY KIND. See http://gnu.org/licenses for details.
 o-----------------------------------------------------------------------------o

  Purpose:
  - Provide regression test suites for the track module.

 o-----------------------------------------------------------------------------o
]=]

--[[
chg  = particle charge
dir  = sequence direction (e.g. lhcb2, dir=-1)
sdir = tracking s-direction
tdir = tracking t-direction (=dir*sdir)
bdir = tracking b-direction (=dir*sdir*chg)

      dir   sdir  chg  |  tdir  bdir
FODO   1     1     1   |   1     1
FODO  -1     1     1   |  -1    -1
ODOF   1    -1     1   |  -1    -1
ODOF  -1    -1     1   |   1     1

DOFO   1     1    -1   |   1    -1
DOFO  -1     1    -1   |  -1     1
OFOD   1    -1    -1   |  -1     1
OFOD  -1    -1    -1   |   1    -1

Usage of directions:
  - lengths        are multiplied by sdir
  - bending angles are multiplied by tdir
  - strengths      are multiplied by bdir
--]]

-- locals ---------------------------------------------------------------------o

local assertTrue, assertEquals, assertAllAlmostEquals           in MAD.utest
local printf, openfile, collectlocal                            in MAD.utility
local is_number                                                 in MAD.typeid
local eps, pi                                                   in MAD.constant

local track, beam, element, sequence, option, filesys           in MAD
local fnone, ftrue                                              in MAD.gfunc

local marker, drift, sbend, rbend, quadrupole, multipole        in element
local observe                                                   in element.flags

local refdir = \s -> 'track_ref/'..(s or '')
local rundir = \s -> 'track_run/'..(s or '')

local tenv = setmetatable(collectlocal(),{__index=_G}) -- ; show(tenv)

filesys.mkdir(rundir()) -- create xxx_run

-- helpers --------------------------------------------------------------------o

local doplot = false

if doplot then
  MAD.atexit(MAD.utility.pause, true)
end

local function plot (mtbl)
  if not doplot then return end
  MAD.plot { table=mtbl, title=mtbl.title,
             x1y1 = { s={'x','px','y','py','t','pt'} } }
end

local function plotxy (mtbl)
  if not doplot then return end
  MAD.plot { table=mtbl, title=mtbl.title, x1y1 = { x='x', y='y'} }
end

-- local -------------------------o

local tbl_col = {'name','s','x','px','y','py','t','pt'}
local tbl_hdr = {'title','type','origin','date','time'}

local slc_p1  = {1}
local slc_p2  = {0.5, 0.5}
local slc_p10 = {0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1}

-- QUAD Testsuite -------------------------------------------------------------o

local QUAD_x0  = {0, 1e-6, 0, 5e-7, 0, 0}

-- track
local QUAD_mdx = {1.460761371e-05    , 2.360452481e-06    , 1.797764445e-06    , -3.929287342e-07    , -1.454192453e-11    , 0}

-- DKD MAD
local QUAD_x1  = {1.4249001987995e-05, 2.3250352677915e-06, 1.8545266806799e-06, -4.1060902658578e-07, -1.4018564087337e-11, 0} -- o=1
local QUAD_x2  = {1.4600656220217e-05, 2.3588119782185e-06, 1.7943847978254e-06, -3.9372067136230e-07, -1.4531875702772e-11, 0} -- o=2
local QUAD_xt  = {1.4606200539093e-05, 2.3602690620606e-06, 1.7977500040831e-06, -3.9282268749294e-07, -1.4538426018618e-11, 0} -- teapot
local QUAD_x4  = {1.4607603046229e-05, 2.3604497079904e-06, 1.7977728935816e-06, -3.9292618283356e-07, -1.4541645665389e-11, 0} -- o=4
local QUAD_x6  = {1.4607613705636e-05, 2.3604524793349e-06, 1.7977644418495e-06, -3.9292873471424e-07, -1.4541645665389e-11, 0} -- o=6
local QUAD_x8  = {1.4607613712814e-05, 2.3604524808132e-06, 1.7977644446180e-06, -3.9292873420957e-07, -1.4541812198843e-11, 0} -- o=8

-- DKD PTC -- TODO
local QUAD_p2  = {1.4607613712814E-05, 2.3604524808134E-06, 1.7977644446181E-06, -3.9292873420967E-07, -1.4269030401692E-11, 0} -- o=2
local QUAD_p4  = {1.4607613712814E-05, 2.3604524808134E-06, 1.7977644446181E-06, -3.9292873420967E-07, -1.4269030401692E-11, 0} -- o=4
local QUAD_p6  = {1.4607613712814E-05, 2.3604524808134E-06, 1.7977644446181E-06, -3.9292873420967E-07, -1.4269030401692E-11, 0} -- o=6

-- TKT MAD
local QUAD_x1t = {1.4607613712822e-05, 2.3604524808133e-06, 1.7977644446161e-06, -3.9292873420962e-07, -1.6777246258926e-11, 0} -- o=1
local QUAD_x2t = {1.4607613712814e-05, 2.3604524808134e-06, 1.7977644446181e-06, -3.9292873420967e-07, -1.4268142223273e-11, 0} -- o=2
local QUAD_xtt = {1.4607613712815e-05, 2.3604524808133e-06, 1.7977644446177e-06, -3.9292873420968e-07, -1.4631407196930e-11, 0} -- teapot
local QUAD_x4t = {1.4607613712814e-05, 2.3604524808133e-06, 1.7977644446178e-06, -3.9292873420967e-07, -1.4538148462861e-11, 0} -- o=4
local QUAD_x6t = {1.4607613712814e-05, 2.3604524808133e-06, 1.7977644446178e-06, -3.9292873420968e-07, -1.4541257087330e-11, 0} -- o=6
local QUAD_x8t = {1.4607613712814e-05, 2.3604524808133e-06, 1.7977644446178e-06, -3.9292873420968e-07, -1.4542589354960e-11, 0} -- o=8

-- TKT PTC -- TODO
local QUAD_p2t = {1.4607613712814E-05, 2.3604524808134E-06, 1.7977644446181E-06, -3.9292873420967E-07, -1.4269030401692E-11, 0} -- o=2
local QUAD_p4t = {1.4607613712814E-05, 2.3604524808134E-06, 1.7977644446181E-06, -3.9292873420967E-07, -1.4269030401692E-11, 0} -- o=4
local QUAD_p6t = {1.4607613712814E-05, 2.3604524808134E-06, 1.7977644446181E-06, -3.9292873420967E-07, -1.4269030401692E-11, 0} -- o=6

-- ptc_create_layout, model={1,2}, method={2,4,6}, nst={1,10}, time=true, exact=true;
-- ptc_track, icase={5,56}, closed_orbit=false, dump, onetable, element_by_element, file="ptctrack_quad_madx.";

local function mkQUAD (dir_, chg_)
  local dir = dir_ or 1 -- sequence direction
  local chg = chg_ or 1 -- particle charge
  local k1f =  0.2110222185*dir*chg
  local k1d = -0.2110222186*dir*chg
  local seq = sequence 'seq' { l=10, refer='entry', dir=dir,
    quadrupole 'm1' {at=0  , l=1.5, k1:=k1f}, -- [1]=multipole{at=0.5}},
    drift      'd1' {at=1.5, l=3.5},
    quadrupole 'm2' {at=5  , l=1.5, k1:=k1d}, -- [1]=multipole{at=0.5}},
    drift      'd2' {at=6.5, l=3.5},
  }
  return seq   -- seq:dumpseq()
end

-- RBEND Testsuite ------------------------------------------------------------o

local RBEND_x0  = {0, 1e-6, 0, 5e-7, 0, 0}

-- track
local RBEND_mdx = {}

-- DKD MAD -- TODO
local RBEND_x1  = {9.1858919308708e-06,  8.2869188041127e-07, 5.0000000000027e-06, 5e-07, 0.00087778356011287, 0} -- o=1
local RBEND_x2  = {9.1984463781625e-06,  8.3235741246724e-07, 5.0000000000027e-06, 5e-07, 0.00087778417279077, 0} -- o=2
local RBEND_xt  = {9.1986606700005e-06,  8.3236330659767e-07, 5.0000000000028e-06, 5e-07, 0.00087778415868867, 0} -- teapot
local RBEND_x4  = {7.6800464604013e-06,  5.1717743362473e-07, 5.0000000000022e-06, 5e-07, 0.00087776879524060, 0} -- o=4
local RBEND_x6  = {4.9671555304774e-06, -3.6496213212427e-08, 5.0000000000017e-06, 5e-07, 0.00087773919545320, 0} -- o=6
local RBEND_x8  = {7.1722244443713e-07, -8.6696141362557e-07, 5.0000000000021e-06, 5e-07, 0.00087768516807019, 0} -- o=8

-- DKD PTC -- TODO (no fringe)
local RBEND_p2  = {9.9991224821975E-06, 9.9999999996978E-07, 4.9823188081225E-06,  4.9620128226007E-07,  2.0944553602575E-07, 0}
local RBEND_p4  = {}
local RBEND_p6  = {}

-- TKT MAD
local RBEND_x1t = {-0.47301905761235, 1.0000000000010e-06, 5.010053825066e-06, 5e-07, -0.019230174855075, 0}
local RBEND_x2t = {-0.47301905761235, 1.0000000000010e-06, 5.010053825066e-06, 5e-07, -0.019230174855075, 0}
local RBEND_xtt = {-0.47301905761235, 1.0000000000079e-06, 5.010053825066e-06, 5e-07, -0.019230174855074, 0}
local RBEND_x4t = {-0.47301905761235, 1.0000000000010e-06, 5.010053825066e-06, 5e-07, -0.019230174855076, 0}
local RBEND_x6t = {-0.47301905761235, 1.0000000000079e-06, 5.010053825066e-06, 5e-07, -0.019230174855074, 0}
local RBEND_x8t = {-0.47301905761235, 9.9999999999406e-07, 5.010053825066e-06, 5e-07, -0.019230174855075, 0}

-- TKT PTC -- TODO (no fringe)
local RBEND_p2t = {9.9991224821975E-06, 9.9999999996978E-07, 4.9823188081225E-06, 4.9620128226007E-07, 2.0944553602575E-07, 0}
local RBEND_p4t = {}
local RBEND_p6t = {}

local function mkRBEND (dir_, chg_)
  local dir = dir_ or 1 -- sequence direction
  local chg = chg_ or 1 -- particle charge
  local k0f =  2*pi/1e2/1.5*dir*chg
  local k0d = -2*pi/1e2/1.5*dir*chg
  local seq = sequence 'seq' { l=10, refer='entry', dir=dir,
    rbend 'm1' {at=0  , l=1.5, k0:=k0f, angle:=k0f},
    drift 'd1' {at=1.5, l=3.5},
    rbend 'm2' {at=5  , l=1.5, k0:=k0d, angle:=k0d},
    drift 'd2' {at=6.5, l=3.5},
  }
  return seq   -- seq:dumpseq()
end

-- SBEND Testsuite ------------------------------------------------------------o

local SBEND_x0  = {0, 1e-6, 0, 5e-7, 0, 0}

-- track
local SBEND_mdx = {}

-- DKD MAD
local SBEND_x1  = {-0.10466243607947, 3.0496173548082e-05, 5.0024734894307e-06, 5e-07, -0.0049469795072827, 0}
local SBEND_x2  = {-0.10465908001655, 2.8567282669057e-05, 5.0024734106437e-06, 5e-07, -0.0049468219333087, 0}
local SBEND_xt  = {-0.10465870348316, 2.8567004279183e-05, 5.0024684555983e-06, 5e-07, -0.0049369118412126, 0}
local SBEND_x4  = {-0.10397803788427, 0.00018144169276163, 5.0024663787749e-06, 5e-07, -0.0049327581939118, 0}
local SBEND_x6  = {-0.10406346979436, 0.00016205052659328, 5.0024666064644e-06, 5e-07, -0.0049332135729150, 0}
local SBEND_x8  = {-0.10182583881541, 0.00066547531408534, 5.0024602165219e-06, 5e-07, -0.0049204336862907, 0}

-- DKD PTC -- TODO
local SBEND_p2  = {9.9991224821975E-06, 9.9999999996978E-07, 4.9823188081225E-06,  4.9620128226007E-07,  2.0944553602575E-07, 0}
local SBEND_p4  = {}
local SBEND_p6  = {}

-- TKT MAD
local SBEND_x1t = {-0.41383201290812, 0.0019129724942666, 5.0158554829641e-06, 5e-07, -0.031710970068425,  0}
local SBEND_x2t = {-0.41314461267492, 0.0018457536279864, 5.0166161377796e-06, 5e-07, -0.033232279897936,  0}
local SBEND_xtt = {-0.41518146630718, 0.0012900949586731, 5.0157641115697e-06, 5e-07, -0.031528227255699,  0}
local SBEND_x4t = {-0.38761788875350, 0.0080237951544151, 5.0159982513886e-06, 5e-07, -0.031996506954657,  0}
local SBEND_x6t = {-0.39009888601832, 0.0072024089257165, 5.0158856946613e-06, 5e-07, -0.031771393470612,  0}
local SBEND_x8t = {-0.30865014682837, 0.0279820403405710, 5.0173513493385e-06, 5e-07, -0.034702703207713,  0}

-- TKT PTC -- TODO
local SBEND_p2t = {9.9991224821975E-06, 9.9999999996978E-07, 4.9823188081225E-06,  4.9620128226007E-07,  2.0944553602575E-07, 0}
local SBEND_p4t = {}
local SBEND_p6t = {}

local function mkSBEND (dir_, chg_)
  local dir = dir_ or 1 -- sequence direction
  local chg = chg_ or 1 -- particle charge
  local k0f =  2*pi/1e2/1.5*dir*chg
  local k0d = -2*pi/1e2/1.5*dir*chg
  local seq = sequence 'seq' { l=10, refer='entry', dir=dir,
    sbend 'm1' {at=0  , l=1.5, k0:=k0f, angle:=k0f},
    drift 'd1' {at=1.5, l=3.5},
    sbend 'm2' {at=5  , l=1.5, k0:=k0d, angle:=k0d},
    drift 'd2' {at=6.5, l=3.5},
  }
  return seq   -- seq:dumpseq()
end

-- Generate Elements Testsuites -----------------------------------------------o

local doprt = false
local t = 'teapot'

collectlocal(1, tenv) -- collect locals

for _,e in ipairs{'QUAD','RBEND','SBEND'} do

  -- prelude
  local s = [[
  _G['TestTrack${e}'] = {}

  function TestTrack${e}:setUp ()
    self.optfmt, option.format = option.format, "%-.16e"
  end

  function TestTrack${e}:tearDown ()
    option.format = self.optfmt
  end
  ]] % { e=e }

  local f = assert(loadstring(s)) ; setfenv(f, tenv) ; f()

for _,o in ipairs{1,2,'t',4,6,8} do   -- orders
for _,m in ipairs{'DKD', 'TKT'} do    -- models
for _,k in ipairs{'',                 -- simple
                  'B', 'R', 'N', 'P', -- backward, reverse, negative, position
                  'BR', 'BN', 'BP', 'RN', 'RP', 'NP',
                  'BRN', 'BRP', 'BNP', 'RNP', 'BRNP'} do

-- discard invalid combination
if not (                 o == 't' and string.find(k,'P',1,true) or
        is_number(o) and o%2 == 1 and string.find(k,'B',1,true)) then

  -- test
  local s = [[
  function TestTrack${e}:test${m}${n}M${o}${k} ()
    local seq  = mk${e}(${r},${s})
    local beam = beam { particle = ${s}>0 and 'positron' or 'electron' }
    local X0   = ${b}>0 and ${e}_x0 or ${e}_x${o}${t}
    local mtbl, mflw = track {sequence=seq, beam=beam, X0=X0, observe=0,
                       model='${m}', method=${o}, nslice=${p}${n}, dir=${b} }

    mtbl:write(rundir('${e}_${m}${n}M${o}${k}'), tbl_col, tbl_hdr)

    local row = mtbl[#mtbl]
    local res = {row.x, row.px, row.y, row.py, row.t, row.pt}
    local ref = ${b}<0 and ${e}_x0 or ${e}_x${o}${t}

    if doprt then print(res[1],res[2],res[3],res[4],res[5],res[6]) end
    assertAllAlmostEquals(res, ref, ${c}*eps)
  end
  ]] % { e=e, o=o, m=m, k=k,
         n=({DKD=10, TKT=1  })[m],
         t=({DKD='', TKT='t'})[m],
         c = string.find(k,'B',1,true) and  2 or 1,        -- eps
         b = string.find(k,'B',1,true) and -1 or 1,        -- track dir
         r = string.find(k,'R',1,true) and -1 or 1,        -- sequ dir
         s = string.find(k,'N',1,true) and -1 or 1,        -- charge sign
         p = string.find(k,'P',1,true) and 'slc_p' or '' } -- position

  local f = assert(loadstring(s)) ; setfenv(f, tenv) ; f()

end end end end end

-- end ------------------------------------------------------------------------o
