! Links definitions
option, warn,info;
set, format="22.16e";

Option, -echo,warn,-info;

call, file="lhc_as-built.seq";
call, file="opt_400_10000_400_3000.madx";

beam, sequence=lhcb1, energy=NRJ, particle=proton;
use, sequence=lhcb1;

select,flag=twiss,clear;
select,flag=twiss, pattern=IP, COLUMN=S, NAME, BETX, BETY, ALFX, ALFY;
twiss,chrom,table, file="lhcb1_twiss.dat";

! ptc_create_universe ;
! ptc_create_layout, model=2, method=4, nst=1, time=true, exact=true ;
! ptc_setswitch, fringe=true, time=true, totalpath=false ;
! ptc_twiss, closed_orbit=true, no=1, icase=5, summary_table ; !="ptc_twiss_summary" ;
! ptc_end ;

!plot haxis = s, vaxis1 = {betx,bety}, vaxis2 = {dx,dy},
!     interpolate, colour = 100;

   match;
    global, q1=64.295, q2=59.301;
    vary,  name=kqtf.b1, step=1.0E-7 ;
    vary,  name=kqtd.b1, step=1.0E-7 ;
    lmdif, calls=100, tolerance=1.0E-21;
   endmatch;

   match, chrom;
     global, dq1=15, dq2=15;
     vary,   name=ksf.b1, step=1.0E-7 ;
     vary,   name=ksd.b1, step=1.0E-7 ;
     lmdif,  calls=100, tolerance=1.0E-21;
   endmatch;

!   match, use_macro;
!    vary, name=kqtf.b1, step=1.0E-7 ;
!    vary, name=kqtd.b1, step=1.0E-7 ;
!    m1: macro = {
!      ptc_create_universe ;
!      ptc_create_layout, model=2, method=4, nst=1, time=true, exact=true ;
!      ptc_setswitch, fringe=true, time=true, totalpath=false ;
!      ptc_twiss, closed_orbit=true, no=1, icase=5, summary_table ;
!      ptc_end ;
!    }
!    constraint expr = table(ptc_twiss_summary,q1)=0.295;
!    constraint expr = table(ptc_twiss_summary,q2)=0.301;
!    lmdif, calls=100, tolerance=1.0E-21;
!   endmatch;

!   match, use_macro;
!    vary, name=ksf.b1, step=1.0E-7 ;
!    vary, name=ksd.b1, step=1.0E-7 ;
!    m1: macro = {
!      ptc_create_universe ;
!      ptc_create_layout, model=2, method=4, nst=1, time=true, exact=true ;
!      ptc_setswitch, fringe=true, time=true, totalpath=false ;
!      ptc_twiss, closed_orbit=true, no=2, icase=5, summary_table ;
!      ptc_end ;
!    }
!    constraint expr = table(ptc_twiss_summary,dq1)=15;
!    constraint expr = table(ptc_twiss_summary,dq2)=15;
!    lmdif, calls=100, tolerance=1.0E-21;
!   endmatch;

twiss,chrom,table, file="lhcb1_twiss_matched.dat";

