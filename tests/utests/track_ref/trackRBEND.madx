option, -info, -rbarc ;

beam ; ! positron 1Gev

k0.qf =  2*pi/1e2/1.5 ;
k0.qd = -2*pi/1e2/1.5 ;
value, k0.qf, k0.qd ;

! SEQUENCE WITH RBENDS
seq: sequence, l=10, refer=entry ;
m1: rbend, at=0  , l=1.5 , k0:=k0.qf, angle:=k0.qf ;
d1: drift, at=1.5, l=3.5 ;
m2: rbend, at=5  , l=1.5 , k0:=k0.qd, angle:=k0.qd ;
d2: drift, at=6.5, l=3.5 ;
endsequence ;

! MATCH THICK LENS
!use, sequence=seq ;
!match, sequence=seq ;
!  ! search for quads strengths
!  vary, name = k0.qf, step = 1e-5 ;
!  vary, name = k0.qd, step = 1e-5 ;
!  ! for cell with phase advance of pi/2 (specified in 2*pi unit!)
!  constraint, range = #e, dpx = 0 ;
!  constraint, range = #e, dpy = 0 ;
!  lmdif, calls = 20, tolerance = 1e-16 ;
!endmatch ;
value, m1->k0, m2->k0 ;

! PTC TRACK
use, sequence=seq ;
ptc_create_universe;
ptc_create_layout, model=2, method=2, nst=1, time=true, exact=true;
ptc_start, x=0, px=1e-6, y=0, py=5e-7, t=0, pt=0;
ptc_observe, place=#s ;
ptc_observe, place=m1 ;
ptc_observe, place=d1 ;
ptc_observe, place=m2 ;
ptc_observe, place=d2 ;
ptc_observe, place=#e ;
ptc_track, icase=56, closed_orbit=false, dump, onetable, element_by_element, file="trackRBENDptc." ;
ptc_track_end;
ptc_end;

! MADX TRACK
use, sequence=seq ;
track, onepass, onetable, dump, file="trackRBENDmadx." ;
start, x=0, px=1e-6, y=0, py=5e-7, t=0, pt=0;
observe, place=#s ;
observe, place=m1 ;
observe, place=d1 ;
observe, place=m2 ;
observe, place=d1 ;
observe, place=#e ;
run, turns=1 ;
endtrack ;
