option, -info ;

beam ;

mqf.k1 =  0.3037241107 ;
mqd.k1 = -0.3037241107 ;

! sequence
fodo: sequence, l=10, refer=entry ;
mqf: quadrupole, at=0, l=1, k1:=mqf.k1 ;
dff: drift,      at=1, l=4 ;
mqd: quadrupole, at=5, l=1, k1:=mqd.k1 ;
dfd: drift,      at=6, l=4 ;
endsequence ;

! check values
value, mqf->k1, mqd->k1 ;

! track
use, sequence=fodo ;
track, onepass, onetable, dump, file="track_fodo_madx." ;
start, x=0, px=1e-6, y=0, py=5e-7, t=0, pt=0;
observe, place=#s ;
observe, place=mqf ;
observe, place=dff ;
observe, place=mqd ;
observe, place=dfd ;
observe, place=#e ;
run, turns=1 ;
endtrack ;

! match thick lens
!use, sequence=cell ;
!match, sequence=cell ;
!  ! search for quads strengths
!  vary, name = k1.qf, step = 1e-5 ;
!  vary, name = k1.qd, step = 1e-5 ;
!  ! for cell with phase advance of pi/2 (specified in 2*pi unit!)
!  constraint range = #e, mux = u.cell/(2*pi) ;
!  constraint, range = #e, muy = u.cell/(2*pi) ;
!  lmdif, calls = 20, tolerance = 1e-16 ;
!endmatch ;

ptc_create_universe;
ptc_create_layout, model=2, method=2, nst=1, time=true, exact=true;
ptc_start, x=0, px=1e-6, y=0, py=5e-7, t=0, pt=0;
ptc_observe, place=#s ;
ptc_observe, place=mqf ;
ptc_observe, place=dff ;
ptc_observe, place=mqd ;
ptc_observe, place=dfd ;
ptc_observe, place=#e ;
ptc_track, icase=56, closed_orbit=false, dump, onetable, element_by_element, file="ptctrack_fodo_madx." ;
ptc_track_end;
ptc_end;
