// MAD-NG First TEST
option, -echo, -info;
TITLE, 'First Test of MAD-NG Results';

kqf  =  0.00872651312 ;
ksf  =  0.0198492943  ;
kqd  = -0.00872777242 ;
ksd  = -0.039621283   ;
kof  = 0.06           ;

l_seq   = 70  ;
l_omk   = 0   ;
l_mult  = 0   ;
l_quad  = 2   ;
l_sext  = 1.1 ;
l_oct   = 0.5 ;
lmbs    = 10. ; !--- arc length of dipole
amb     = 0.01 ;  !angle


factor    := amb / (2*sin(amb/2) ) ;
value factor ;
!lstraight := lmbs/factor           ;
lstraight := lmbs/factor           ;
lmbr      =  10             ; 
larch = lmbr*factor ;

value larch ;
value amb/larch ;
kmb = 0.03;
ee1 = 0.001;
ee2 = 0.0001; ! 10 m long dipole, bending 10 mrad, so that rho = 1000 meter
! typical fint values range from 0.3 to 1,
! only have an effect if also the gap h is given,
! for the gap take something of the order 10 cm or 0.1

mb_fint =0.5;
mb_fintx=0.6;

mb_hgap=0.12;
mb_tilt=0.013;
msol = 0.2;

omk : marker,     l := l_omk ;
qf  : quadrupole, l := l_quad, k1 := kqf ;
qd  : quadrupole, l := l_quad, k1 := kqd ;
sf  : sextupole,  l := l_sext, k2 := ksf ;
sd  : sextupole,  l := l_sext, k2 := ksd ;
of  : octupole,   l := l_oct , k3 := kof ;
qfm : multipole,  l := l_mult, knl = { 0.003, kqf * 3.1 * 0.2, -0.05 },  ksl= {0, 0.006} ;
mbs : sbend,      l:=lmbs, angle:=amb, k1=0.003, k2s=0.004, kill_ent_fringe=true, kill_exi_fringe=true ;
!mbr : rbend,      l=lmbr, angle:=amb, k0 = 0.01, k3=0.06 ; ! as mb1 but rbend
!mbr : rbend,      l=lmbr, angle:=amb, k0 = 0.01, truerbend=true, ptcrbend=true  ; ! as mb1 but rbend
!mbr : rbend,      l:=lmbr, angle:=amb , k2 = 0.03  ; ! as mb1 but rbend
!mbs : sbend,      l:=lmbs, angle:=amb, k1:=kmb, e1:=ee1, e2:=ee2, fint=0.5, fintx=0.5, hgap =mb_hgap, tilt =mb_tilt;
!mbr : rbend,      l:=lmbr, angle:=amb, fint=0.7, k1:=kmb, e2:=ee2, hgap =mb_hgap; ! as mb1 but rbend
sol : solenoid,    l=0.5, ks := msol;


ttt1: sequence, refer = centre, l := l_seq ;
IP1 : omk,            at= 0  ;
!QF1 : qf              at= 0  ;
!SF1 : sf              at= 6  ;
!IP2 : omk,            at= 9  ;
!OF1 : of              at= 9  ;
!IP3 : omk,            at= 10 ;
!QFM1: qfm             at= 10 ;
!QD1 : qd              at= 13 ;
!SD1 : sd              at= 16 ;
!IP2 : omk,            at= 30 ;
SB1 : mbs             at= 30 ;
!IP3 : omk,            at= 40 ;
!SR1 : mbr             at= 50 ;
!SL1:   sol            at=60  ;   
IP4 : omk,            at= 70 ;
ENDSEQUENCE ;

BEAM, PARTICLE=PROTON, ENERGY=450 ;
use, sequence = ttt1 ;

select flag=twiss, column={name, s, l, x, px, y, py, t, pt } ;

!TWISS 
!twiss file='twiss.tsf', x=1e-4, y=1e-4, pt=1e-6, betx=10, bety=10 ;

! track, onepass, file="track_sbend", deltap=dp0;
!        start,  x=1e-4, px=0, y=1e-4, py=0, t=0, pt=1e-6;
!        observe, place=ip1;
!        observe, place=sb1;
!        observe, place=ip4;
!        run,   turns= 1;
! endtrack;



value lmbr;
!PTC
ptc_create_universe;
ptcrbend=true;
ptc_create_layout model=1, method=2, nst=1, exact=true, time=true, closed_layout=false ;
ptc_setswitch debuglevel=1, nocavity=true, time=true, totalpath=false, fringe=false;
ptc_start x=1e-4, px=0, y=1e-4, py=0, t=0, pt=1e-6;
ptc_observe place = ip1 ;
ptc_observe place = ip2 ;
ptc_observe place = qf1 ;
ptc_observe place = sf1 ;
ptc_observe place = ip2 ;
ptc_observe place = of1 ;
ptc_observe place = ip3 ;
ptc_observe place = qfm1 ;
ptc_observe place = qd1 ;
ptc_observe place = sd1 ;
ptc_observe place = sb1 ;
ptc_observe place = sr1 ;
ptc_observe place = sl1 ;
ptc_observe place = ip4 ;

ptc_track icase=6, closed_orbit=false, element_by_element=true, turns=1, onetable=true, dump=true, file='track_ptc.tfs';
ptc_track_end;
ptc_end;
value 10/factor ;

stop ;
