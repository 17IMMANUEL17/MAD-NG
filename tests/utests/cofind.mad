--[=[
 o-----------------------------------------------------------------------------o
 |
 | Close orbit finder tests
 |
 | Methodical Accelerator Design - Copyright CERN 2016+
 | Support: http://cern.ch/mad  - mad at cern.ch
 | Authors: L. Deniau, laurent.deniau at cern.ch
 | Contrib: -
 |
 o-----------------------------------------------------------------------------o
 | You can redistribute this file and/or modify it under the terms of the GNU
 | General Public License GPLv3 (or later), as published by the Free Software
 | Foundation. This file is distributed in the hope that it will be useful, but
 | WITHOUT ANY WARRANTY OF ANY KIND. See http://gnu.org/licenses for details.
 o-----------------------------------------------------------------------------o

  Purpose:
  - Provide regression test suites for the cofind module.

 o-----------------------------------------------------------------------------o
]=]

-- locals ---------------------------------------------------------------------o

local assertNotNil, assertEquals, assertAlmostEquals, assertAllAlmostEquals,
      assertStrContains, assertErrorMsgContains                  in MAD.utest

local sequence, beam, cofind, plot, option, filesys              in MAD
local fnone, ftrue                                               in MAD.gfunc
local marker, drift, multipole                                   in MAD.element
local eps, pi                                                    in MAD.constant
local openfile                                                   in MAD.utility

local refdir = \s -> 'cofind_ref/'..(s or '')
local rundir = \s -> 'cofind_run/'..(s or '')

-- Tests ----------------------------------------------------------------------o

TestCOFind = {}

function TestCOFind:setUp ()
  filesys.mkdir(rundir())
  self.optfmt = option.format
  option.format = "%-.10g"
end

function TestCOFind:tearDown ()
  option.format = self.optfmt
end

  -- TODO: 6D case

function TestCOFind:testCOThinFODOdamap ()
  local nsl = 10
  local dl  = 1/nsl
  local X0  = { 1e-3, -1e-4, -1e-3, 1e-4, 0, 0 }
  local k1l = 0.3037241107
  local mq1 = multipole 'mq1' { knl := {0,  k1l/nsl} }
  local mq2 = multipole 'mq2' { knl := {0, -k1l/nsl} }
  local seq = sequence 'seq' { l=10, refer='entry', -- dir=-1,
                mq1 {at=0+dl/2}, (nsl-1)*mq1 {at=dl, from='prev'},
                mq2 {at=5+dl/2}, (nsl-1)*mq2 {at=dl, from='prev'},
              }

  local _, mflw, X0 = cofind { sequence=seq, beam=beam, X0=X0, mapdef=true }

  -- closed orbit
  local X0r = {-8.764300516e-10,-3.517407195e-10,-8.441875434e-10,1.930347485e-10,0,0}
  -- orbit at the end for closed orbit
  local Xr = {-3.346684905e-09,-4.583005844e-10,8.830944188e-11,2.371181165e-10,0,0}
  assertEquals(mflw.npar, 1)
  assertEquals(mflw[1].status, 'stable')
  assertEquals(mflw[1].rank, 4)
  assertEquals(mflw[1].coiter, 2)
  assertAllAlmostEquals(mflw[1]:get0():totable(), Xr, eps)
  assertAllAlmostEquals(X0[1]:totable(), X0r, eps)
end

function TestCOFind:testCOThinFODOpart ()
  local nsl = 10
  local dl  = 1/nsl
  local X0  = { 1e-3, -1e-4, -1e-3, 1e-4, 0, 0 }
  local k1l = 0.3037241107
  local mq1 = multipole 'mq1' { knl := {0,  k1l/nsl} }
  local mq2 = multipole 'mq2' { knl := {0, -k1l/nsl} }
  local seq = sequence 'seq' { l=10, refer='entry', -- dir=-1,
                mq1 {at=0+dl/2}, (nsl-1)*mq1 {at=dl, from='prev'},
                mq2 {at=5+dl/2}, (nsl-1)*mq2 {at=dl, from='prev'},
              }

  local _, mflw, X0 = cofind { sequence=seq, beam=beam, X0=X0, mapdef=false }

  -- closed orbit
  local X0r = {-8.773511507e-10,-3.519359875e-10,-8.443421535e-10,1.93065811e-10,0,0}
  -- orbit at the end for closed orbit
  local Xr = {x=-3.347510606e-09,px=-4.583679855e-10,y=8.831138311e-11,py=2.371643494e-10,t=0,pt=0}
  assertEquals(mflw.npar, 1)
  assertEquals(mflw[1].status, 'stable')
  assertEquals(mflw[1].rank, 4)
  assertEquals(mflw[1].coiter, 2)
  assertAllAlmostEquals(mflw[1], Xr, eps)
  assertAllAlmostEquals(X0[1]:totable(), X0r, eps)
end

-- end ------------------------------------------------------------------------o
