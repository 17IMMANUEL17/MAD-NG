! time ../madx64 lhc_job.madx

option, -echo, -warn, -info ;

call, file="lhc_as-built.seq" ;
call, file="opticsfile.22_ctpps2" ;

option, warn ;

system, "rm -f *.tfs *.txt fort.*" ;

create, table=C1, column={_name,keyword,
   "c10","c20","c30","c40","c50","c60",
   "c11","c12","c13","c14","c15","c16",
   "c21","c22","c23","c24","c25","c26",
   "c31","c32","c33","c34","c35","c36",
   "c41","c42","c43","c44","c45","c46",
   "c51","c52","c53","c54","c55","c56",
   "c61","c62","c63","c64","c65","c66"} ;

ptc_select, table=C1, column="c10", polynomial=1, monomial="000000";
ptc_select, table=C1, column="c11", polynomial=1, monomial="100000";
ptc_select, table=C1, column="c12", polynomial=1, monomial="010000";
ptc_select, table=C1, column="c13", polynomial=1, monomial="001000";
ptc_select, table=C1, column="c14", polynomial=1, monomial="000100";
ptc_select, table=C1, column="c15", polynomial=1, monomial="000010";
ptc_select, table=C1, column="c16", polynomial=1, monomial="000001";

ptc_select, table=C1, column="c20", polynomial=2, monomial="000000";
ptc_select, table=C1, column="c21", polynomial=2, monomial="100000";
ptc_select, table=C1, column="c22", polynomial=2, monomial="010000";
ptc_select, table=C1, column="c23", polynomial=2, monomial="001000";
ptc_select, table=C1, column="c24", polynomial=2, monomial="000100";
ptc_select, table=C1, column="c25", polynomial=2, monomial="000010";
ptc_select, table=C1, column="c26", polynomial=2, monomial="000001";

ptc_select, table=C1, column="c30", polynomial=3, monomial="000000";
ptc_select, table=C1, column="c31", polynomial=3, monomial="100000";
ptc_select, table=C1, column="c32", polynomial=3, monomial="010000";
ptc_select, table=C1, column="c33", polynomial=3, monomial="001000";
ptc_select, table=C1, column="c34", polynomial=3, monomial="000100";
ptc_select, table=C1, column="c35", polynomial=3, monomial="000010";
ptc_select, table=C1, column="c36", polynomial=3, monomial="000001";

ptc_select, table=C1, column="c40", polynomial=4, monomial="000000";
ptc_select, table=C1, column="c41", polynomial=4, monomial="100000";
ptc_select, table=C1, column="c42", polynomial=4, monomial="010000";
ptc_select, table=C1, column="c43", polynomial=4, monomial="001000";
ptc_select, table=C1, column="c44", polynomial=4, monomial="000100";
ptc_select, table=C1, column="c45", polynomial=4, monomial="000010";
ptc_select, table=C1, column="c46", polynomial=4, monomial="000001";

ptc_select, table=C1, column="c50", polynomial=5, monomial="000000";
ptc_select, table=C1, column="c51", polynomial=5, monomial="100000";
ptc_select, table=C1, column="c52", polynomial=5, monomial="010000";
ptc_select, table=C1, column="c53", polynomial=5, monomial="001000";
ptc_select, table=C1, column="c54", polynomial=5, monomial="000100";
ptc_select, table=C1, column="c55", polynomial=5, monomial="000010";
ptc_select, table=C1, column="c56", polynomial=5, monomial="000001";

ptc_select, table=C1, column="c60", polynomial=6, monomial="000000";
ptc_select, table=C1, column="c61", polynomial=6, monomial="100000";
ptc_select, table=C1, column="c62", polynomial=6, monomial="010000";
ptc_select, table=C1, column="c63", polynomial=6, monomial="001000";
ptc_select, table=C1, column="c64", polynomial=6, monomial="000100";
ptc_select, table=C1, column="c65", polynomial=6, monomial="000010";
ptc_select, table=C1, column="c66", polynomial=6, monomial="000001";

beam, sequence=lhcb1, energy=nrj, particle=proton ;
use, sequence=lhcb1 ;
! show, beam%lhcb1;

ptc_create_universe ;
ptc_create_layout, model=2, method=4, nst=1, time=true, exact=true ;
ptc_setswitch, debuglevel=3, mapdump=2, exact_mis=true, time=true, totalpath=false ;

ptc_twiss, closed_orbit=false, no=2, icase=56, table=ptc_twiss,
           rmatrix=true, writetmap=true, savemaps=true, maptable=true,
           x=-5.5E-004, px=0, y=0, py=1.6E-004, t=0, pt=0 ;
           !, writetmap ; !, deltap=1e-6 ;

set, format = "-.16e" ;
write, table=C1, file="Cptc_tr.txt" ;
write, table=ptc_twiss, file="Cptc_tw.txt" ;

removefile, file="internal_mag_pot.txt" ;

ptc_end;

stop;

!select, flag=ptc_twiss, clear ;
!select, flag=ptc_twiss, column={name,s,l,beta11,alfa11,mu1,beta22,alfa22,mu2,disp1,disp3} ;
!write, table=twiss, file="twiss_table.txt" ;

! results
! q1=0.310006, dq1=1.23317
! q2=0.320007, dq2=1.34619


myx =1.0e-3;
myy =1.3e-3;
mypx=1.2e-3;
mypy=1.1e-3;

ptc_create_universe;
ptc_create_layout, model=2, method=4, nst=1, time=true, exact=true;
select, flag=ptc_twiss,column=name,s,beta11,alfa11,mu1,beta22,alfa22,mu2,disp1,disp2,disp3,disp4;

! TWISS
ptc_twiss,closed_orbit,no=2,icase=5,file="nominal_ptc.tfs";

! TRACK
ptc_start, x=myx, px=mypx, y=myy, py=mypy;
ptc_observe, place=ip2;
ptc_track,icase=5,closed_orbit,dump,turns=2,norm_no=2,element_by_element;
ptc_track_end;

ptc_end;




