MADX:open_env()

-- tie lhcb2 to lhcb1

lhcb1:tie(lhcb2)

-- proper settings of sequence direction

lhcb1.dir = +1
lhcb2.dir = -1

-- change RBEND to SBEND to allow angle ~= 0

local eface = \s -> s.angle/2

mbrb :set_parent(sbend) :set{ e1=eface, e2=eface }
mbrc :set_parent(sbend) :set{ e1=eface, e2=eface }
mbrs :set_parent(sbend) :set{ e1=eface, e2=eface }
mbw  :set_parent(sbend) :set{ e1=eface, e2=eface }
mbx  :set_parent(sbend) :set{ e1=eface, e2=eface }
mbxw :set_parent(sbend) :set{ e1=eface, e2=eface }

MADX:close_env()

-- MAD-X survey compat.

-- local E = MAD.element
-- E.multipole.angle = \s -> hypot((s.knl[1] or 0), (s.ksl[1] or 0))
-- E.multipole.tilt  = \s -> -atan2(s.ksl[1] or 0 ,  s.knl[1] or 0 )

local E = MAD.element
E.kicker.knl  = \s -> { s.hkick }
E.kicker.ksl  = \s -> { s.vkick }
E.hkicker.knl = \s -> { s.hkick or s.kick }
E.vkicker.ksl = \s -> { s.vkick or s.kick }
