MADX:open_env()

-- proper settings of sequence direction

lhcb1.dir = +1 -- default
lhcb2.dir = -1

-- change RBEND to SBEND to allow angle ~= 0

local eface = \s -> s.angle/2

mbrb :set_parent(sbend) :set{ e1=eface, e2=eface }
mbrc :set_parent(sbend) :set{ e1=eface, e2=eface }
mbrs :set_parent(sbend) :set{ e1=eface, e2=eface }
mbw  :set_parent(sbend) :set{ e1=eface, e2=eface }
mbx  :set_parent(sbend) :set{ e1=eface, e2=eface }
mbxw :set_parent(sbend) :set{ e1=eface, e2=eface }

-- MAD-X survey compat. (?)

-- E.multipole.knl   = {}
-- E.multipole.ksl   = {}
-- E.multipole.angle = \s -> hypot((s.knl[1] or 0), (s.ksl[1] or 0))
-- E.multipole.tilt  = \s -> -atan2(s.ksl[1] or 0 ,  s.knl[1] or 0 )

MADX:close_env()
