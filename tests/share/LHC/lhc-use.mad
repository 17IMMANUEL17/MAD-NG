-- trick to check if a file exists
local exists = \name -> os.rename(name, name) and true or false

local load = true

-- convert only if needed
if not exists("lhc_as-built_gen.mad") then
  if arg[1] == "mem" then -- in memory
    print("loader: madx to memory")
    MADX:load("lhc_as-built.seq")
    MADX:load("lhc_uvar.madx"   )
    MADX:load("opt_inj.madx"    )
    load = false
  else                    -- to file (default)
    print("loader: madx to mad files")
    MADX:load("lhc_as-built.seq", "lhc_as-built_gen.mad")
    MADX:load("lhc_uvar.madx"   , "lhc_uvar_gen.mad"    )
    MADX:load("opt_inj.madx"    , "opt_inj_gen.mad"     )
  end
end

if load == true then
  print("loader: mad files to memory")
  require 'lhc_as-built_gen'
  require 'lhc_uvar_gen'
  require 'opt_inj_gen'
end

local lhcb1, lhcb2 in MADX

print('#lhcb1=', #lhcb1)
print('#lhcb2=', #lhcb2)

print("lhcb2['unknown'].idx="       , lhcb2:index_of 'unkown')
print("lhcb2['BPMWB.4L1.B2'].idx="  , lhcb2:index_of 'BPMWB.4L1.B2')
print("lhcb2['BPMWB.4L1.B2'].s_pos=", lhcb2:spos_of 'BPMWB.4L1.B2')
print("lhcb2['IP1.L1'].s_pos="      , lhcb2:spos_of 'IP1.L1')
print("lhcb2.l="                    , lhcb2.l)
print("lhcb2.l-IP1.L1="             , lhcb2.l-lhcb2:spos_of 'IP1.L1')