local lhcb1, lhcb2 in MADX
local bind1st      in MAD.gfunc

-- MAD-X compatibility --------------------------------------------------------o

-- Warning: only sequence scope should be modified!
--          Do not touch to MAD environment!

-- change angle of RBEND for MAD-X compatibility
if option.rbarc == true then
if MADX.option.rbarc == true then
  local rbarc in MADX
  local toarc = \s,e => if e.kind == 'rbend' then rbarc(e) s:update(e.name) end
                        end

  fivecell:foreach((bind1st(toarc,toarc))
end

-- change RBEND to SBEND for MAD-X compatibility
local eface = \s -> s.angle/2
local sbend, mb in MADX

mb :set_parent(sbend) :setv{ e1=eface, e2=eface }

-- sanity checks
fivecell:foreach \e -> assert(e.kind ~= 'rbend', "unexpected rbend")

-- kickers compatibilty (to be reviewed)
local E = MAD.element
E. kicker.knl = \s -> ( s.hkick and { -s.hkick } )
E. kicker.ksl = \s -> ( s.vkick and {  s.vkick } )
E.hkicker.knl = \s -> ((s.hkick or s.kick) and { -(s.hkick or s.kick) })
E.vkicker.ksl = \s -> ((s.vkick or s.kick) and {   s.vkick or s.kick  })

-- end of setup ---------------------------------------------------------------o
